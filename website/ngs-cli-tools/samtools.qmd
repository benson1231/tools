---
title: "Samtools 基本使用"
date: today
date-format: "YYYY-MM-DD"
engine: knitr
---

# Samtools 基本介紹

[samtools](https://github.com/samtools/samtools) 是處理高通量定序（Next-Generation Sequencing, NGS）比對資料的核心工具套件，用於操作 SAM（Sequence Alignment/Map）與 BAM（Binary Alignment/Map）文件格式。SAM/BAM 是儲存序列與參考基因組比對結果的標準格式，而 samtools 提供快速、高效、彈性的指令協助使用者解析與管理這些資料。另外還有更高效能、高度平行的工具 [sambamba](https://github.com/biod/sambamba)。

> Petr Danecek, James K Bonfield, Jennifer Liddle, John Marshall, Valeriu Ohan, Martin O Pollard, Andrew Whitwham, Thomas Keane, Shane A McCarthy, Robert M Davies, Heng Li
GigaScience, Volume 10, Issue 2, February 2021, giab008, https://doi.org/10.1093/gigascience/giab008

## Samtools 的主要功能

samtools 涵蓋了 NGS 比對檔案處理的幾乎所有基礎步驟，包括：

- 檔案格式轉換（SAM ↔ BAM）
- 排序（Sorting）與索引（Indexing）
- 區域擷取（Region Extraction）
- 基礎統計（flagstat, idxstats, coverage, stats）
- 檔案合併與拆分（merge, split）

## Samtools 的特色

* **高速、低記憶體需求**：建立在 htslib 之上，效能優異
* **與主流工具鏈相容**：如 BWA、Bowtie2、GATK、DeepVariant、nf-core pipelines
* **CLI 工作流程簡單、模組化**：各指令可自由組合
* **支援 CRAM 格式（壓縮率更高）**：可在提供參考序列時大幅節省硬碟空間

## Samtools 分析角色

samtools 常用於以下生物資訊流程：

* **比對後處理（post-alignment processing）**
* **品質檢查（QC）**：檢查 mapping 成功率、深度是否正常
* **擷取特定基因區域**：Sanger validation、視覺化前資料抽取
* **變異分析前的必要步驟**：排序、索引、清理比對檔

---

# samtools --version

使用 `--version` 參數確認 samtools 是否成功安裝，並顯示版本號。

```{bash}
samtools --version
```

---

# samtools faidx (建FASTA索引)
## index FASTA

建立 FASTA index

```bash
samtools faidx ../../.test/ex1.fa
```

---

# samtools sort (排序)

對 BAM 檔排序，以利後續建立索引或快速查詢。

```bash
samtools sort -o ../../.test/ex1.sorted.bam ../../.test/ex1.bam
```

---

# samtools index (建BAM索引)

建立 bam 檔的 index file `bai`，供後續索引

```bash
samtools index ../../.test/ex1.sorted.bam
```

---

# samtools view (轉檔、篩選與過濾等)

`samtools view` 是 samtools 套件中最常使用的指令之一，負責從 SAM/BAM/CRAM 中擷取資料、轉換格式、過濾 reads、以及抽取區域。透過不同參數組合，可快速針對 mapping 品質、FLAG 標記、比對狀態等條件進行篩選，是 NGS 分析中不可或缺的核心指令。

```{bash}
samtools view --help
```

## SAM 轉 BAM

`-b` 輸出bam，`-t` 提供 FASTA index(.fai)供 SAM 轉換 BAM，`-o <output.bam>` 指定輸出 BAM 檔的名稱

```bash
samtools view -b -t ../../.test/ex1.fa.fai -o ../../.test/ex1.bam ../../.test/ex1.sam.gz
```

## BAM 轉 SAM

```bash
samtools view -h -o ../../.test/ex1.sam.gz ../../.test/ex1.bam
```

## 查看 bam 檔

default 不包含header，`-h` 含 header，`-H` 只看 header

```{bash}
# 查看所有比對結果（不含 header）
samtools view ../../.test/ex1.bam | head
```

```{bash}
# 查看所有比對結果（含 header）
samtools view -h ../../.test/ex1.bam | head
```

```{bash}
# 只輸出 BAM 的 header
samtools view -H ../../.test/ex1.bam
```

## 搜尋特定區域

```{bash}
# 提取 chr2 450-550 的比對結果
samtools view ../../.test/ex1.sorted.bam seq2:450-550 | head
```

```{bash}
# 根據 BED 檔指定區域提取比對
samtools view -L ../../.test/ex1.bed ../../.test/ex1.sorted.bam | head
```

## samtools view 常用於進行篩選

| 選項                           | 說明                             | 常見用途                            | 範例                                          |
| ---------------------------- | ------------------------------ | ------------------------------- | ------------------------------------------- |
| `-q INT`                     | 依 **mapping quality** 過濾 reads | 去除低品質比對                         | `samtools view -q 20 sample.bam`            |
| `-f FLAG`                    | 只保留符合 FLAG 的 reads             | 保留 properly paired、first/second | `samtools view -f 2 sample.bam`             |
| `-F FLAG`                    | 排除符合 FLAG 的 reads              | 排除 unmapped、secondary、duplicate | `samtools view -F 4 sample.bam`             |
| `-h`                         | 輸出 header + reads              | 保留 header 的 SAM 格式輸出            | `samtools view -h sample.bam`               |
| `-H`                         | 只輸出 header                     | 查看 BAM header                   | `samtools view -H sample.bam`               |
| `-L bed-file`                | 依 BED 區域擷取 reads               | 多區域抽取                           | `samtools view -L targets.bed sample.bam`   |
| `-@ INT`                     | 使用多核心運算                        | 加速大 BAM 解析                      | `samtools view -@ 8 sample.bam`             |
| `--bam` /  `--cram`          | 指定輸出格式                         | 強制轉換格式                          | `samtools view --cram input.bam`            |
| `region`（如 chr:start-end） | 擷取特定座標區段                       | 基因區域分析                          | `samtools view sample.bam chr1:10000-20000` |

---

# samtools flags (flag 解讀)

`samtools flags` 用於查詢 SAM/BAM FLAG 的 bit 組合與含義，可協助判讀 `samtools view -f` 與 `-F` 的篩選條件。

```{bash}
samtools flags
```

`samtools flags <INT>` 可以解析該 FLAG 整數所代表的 bit 與狀態

```{bash}
samtools flags 2
samtools flags 4
```

---

# samtools flagstat

`samtools flagstat` 會讀取 BAM/SAM/CRAM，並輸出一段簡短但非常重要的 mapping 統計，包括： read 總數、mapped reads 比例、properly paired 比例、duplicates 數量、singletons 數量、mate mapping 狀況（同 chr / diff chr）、QC-failed reads

```{bash}
samtools flagstat ../../.test/ex1.bam
```


| 欄位名稱                               | 說明                                              | 代表意義                                        | 常見 QC 解讀                                       |
| ---------------------------------- | ----------------------------------------------- | ------------------------------------------- | ---------------------------------------------- |
| **in total**                       | 總 reads 數（QC-passed + QC-failed）                | 原始讀序的整體數量                                   | 數量是否符合預期？太低可能是 library 問題                      |
| **primary**                        | primary alignment 數（排除 secondary/supplementary） | 用於主要分析的 reads                               | primary 過低 → mapping 混亂或多重比對過多                 |
| **secondary**                      | secondary alignment（多重比對）                       | aligner 找到多個 mapping 位置                     | 過高 → 重複序列或 mapping 參數寬鬆                        |
| **supplementary**                  | supplementary alignment（如 chimeric read）        | split-read mapping                          | 過高可能代表結構變異或 chimera                            |
| **mapped**                         | 成功比對到參考序列的 reads（%）                             | mapping rate（最重要 QC 指標之一）                   | WGS/WES 通常 >90%；太低可能是污染或物種不符                   |
| **paired in sequencing**           | paired-end 資料中成對的 reads                         | 應等於總 PE reads                               | 若意外偏低 → 資料不完整或文件損壞                             |
| **read1 / read2**                  | read1 及 read2 的數量                               | 正常應接近相等                                     | 不平衡 → sample degrade 或跑 Lane 不均                |
| **properly paired**                | 合理方向 + 合理距離的 read pairs                         | alignment 品質是否正常                            | WGS 通常 >90%；太低 → insert size 問題或 contamination |
| **with itself and mate mapped**    | read 與其 mate 都成功比對                              | paired-end mapping 完整性                      | 若低 → read2 不齊全（如跑丟一端）                          |
| **singletons**                     | 只有一端比對成功                                        | library degrade、read 质量差或 RNA fragmentation | WGS 通常 <3%；高可能代表 sample degrade                |
| **mate mapped to a different chr** | mate pair 在不同染色體                                | 可能是真實結構變異、錯配、或 mapping 錯誤                   | 過高可能是污染或 aligner 參數過寬                          |

---

# samtools merge

用於合併多個 BAM 檔為單一檔案。

```bash
samtools merge -o ../../.test/merge.bam ../../.test/ex1.bam ../../.test/ex1.sorted.bam
```

---

# samtools coverage

`samtools coverage` 用於計算每條染色體的平均深度（mean depth）、覆蓋率（coverage%）與一些區域性統計資訊。

```{bash}
samtools coverage ../../.test/ex1.sorted.bam
```

| 欄位名稱             | 說明                             | 代表意義                  | 常見 QC 解讀                                             |
| ---------------- | ------------------------------ | --------------------- | ---------------------------------------------------- |
| **rname**        | 參考序列名稱（染色體/contig）             | 統計對應到哪條染色體            | 用於檢查 coverage 是否在不同染色體間均勻                            |
| **startpos**     | 區域起始位置                         | 一般為 1                 | 無特別 QC 使用，作為範圍參考                                     |
| **endpos**       | 區域終止位置                         | 等於染色體長度               | 無特別 QC 使用，作為範圍參考                                     |
| **numreads**     | 覆蓋該染色體的 reads 數量               | 用來判斷 reads 在各染色體的分布狀況 | 若某染色體過低 → 可能 mapping 偏差或樣本問題                         |
| **covbases**     | 被 ≥1 read 覆蓋的碱基數量              | 計算 coverage% 的分子      | 若明顯偏低 → dropout、capture 不良、mapping 問題                |
| **coverage (%)** | covbases / endpos × 100        | 染色體實際覆蓋率              | WGS/WES 需接近 100%；panel 低 coverage 會造成 false negative |
| **meandepth**    | 平均深度（mean depth）               | 最重要深度 QC 指標           | WGS 30X/60X；WES/panel 依設計不同，過低會影響 variant calling    |
| **meanbaseq**    | 覆蓋到之碱基的平均 base quality         | Reads 序列品質代表          | 若偏低 → read 品質差或 instrument 問題                        |
| **meanmapq**     | 覆蓋到之 reads 的平均 mapping quality | 對齊品質指標                | <30 代表 mapping 可能不可靠、參考序列不符或比對參數錯誤                   |

---

# samtools depth

`samtools depth` 用於輸出 BAM 中 每個位置（per-base） 的深度（depth）

```{bash}
samtools depth ../../.test/ex1.sorted.bam | head
```

| 欄位        | 名稱          | 說明              | QC 用途                        |
| --------- | ----------- | --------------- | ---------------------------- |
| **chrom** | 染色體名稱       | 比對到的參考序列名稱      | 用於識別區域 depth 分布              |
| **pos**   | 位置（1-based） | 該位置在參考基因組的座標    | 用來定位 low-depth 或 dropout 位置  |
| **depth** | read 深度     | 覆蓋該位置的 reads 數目 | panel/WES 最主要 coverage QC 資料 |


## 計算平均深度

```{bash}
samtools depth ../../.test/ex1.sorted.bam | awk '{sum += $3} END {print sum/NR}'
```

---

# samtools idxstats

`samtools idxstats` 用於顯示 每條染色體的 read 數量與參考序列長度，依靠 BAM 的 index (.bai 或 .csi)

```{bash}
samtools idxstats ../../.test/ex1.sorted.bam
```

| 欄位           | 名稱                  | 說明                     | 意義 / QC 用途              |
| ------------ | ------------------- | ---------------------- | ----------------------- |
| **chrom**    | 染色體 / contig 名稱     | 參考序列名稱                 | 用來檢查 contig 是否異常或有污染    |
| **length**   | 序列長度                | 該 chromosome 在參考序列中的大小 | 檢查 reference build 是否一致 |
| **mapped**   | 成功比對到該染色體的 reads 數量 | 染色體層級 mapping 數        | mapping 是否均勻；chrM 是否過高  |
| **unmapped** | 比對失敗但位於此條目的 reads   | 代表某些 read 無法比對         | unmapped 太多可能是污染或品質差    |

---

# samtools stats

samtools stats 是 最完整的 mapping 統計，提供： mapping 深度、read 長度分布、GC 分布、按距離區分的 insert size 分布、mismatch / error rate 與 per-chromosome 統計

```{bash}
samtools stats ../../.test/ex1.sorted.bam | head
```

| 欄位                                 | 說明                 | 意義 / QC 用途                     |
| ---------------------------------- | ------------------ | ------------------------------ |
| **raw total sequences**            | 原始讀序數量             | 檢查整體資料量是否足夠                    |
| **filtered sequences**             | 被 filter 掉的 reads  | 若 >0 → 上游 pipeline 有過濾步驟       |
| **sequences**                      | 參與比對的 reads        | 通常 = raw total - filtered      |
| **is sorted**                      | BAM 是否已排序          | GATK / bcftools pipeline 必須為 1 |
| **average length**                 | read 平均長度          | 檢查是否符合平台（Illumina 150bp）       |
| **average quality**                | base quality 平均值   | <30 可能是低品質序列                   |
| **insert size average**            | 插入片段長度             | WES/WGS 中非常關鍵                  |
| **insert size standard deviation** | 插入長度變異             | 變異大 → library 不均勻              |
| **average depth**                  | 整體平均深度             | 判斷是否達到 WGS 30X / WES 100X      |
| **error rate**                     | mismatches / bases | 高 error rate → 可能污染            |

---

# samtools --help

顯示 samtools 提供的主要參數與使用說明，適合作為快速查詢指令用途。

```{bash}
samtools --help
```
